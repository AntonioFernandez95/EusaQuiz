<div class="reports-container">
  <!-- Header -->
  <header class="dashboard-header animate-fade-in">
    <div class="logo" (click)="goBack()">
      <img
        [src]="brandingService.appLogo$ | async"
        [alt]="brandingService.appName$ | async"
        class="logo-img"
      />
    </div>
    <div class="page-title-center">Análisis y Reportes</div>
    <div class="user-profile">
      <div
        class="user-avatar-wrapper"
        (click)="triggerProfileUpload()"
        title="Cambiar foto de perfil"
        style="cursor: pointer"
      >
        <div class="user-avatar">
          <img
            *ngIf="userProfileImg"
            [src]="userProfileImg"
            alt="Perfil"
            class="profile-img-avatar"
            (error)="onImgError()"
          />
          <!-- Same fallback logic as dashboard -->
          <span *ngIf="!userProfileImg">{{ userInitials }}</span>
          <!-- Overlay icon for better UX -->
          <div class="avatar-overlay">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
              />
              <circle cx="12" cy="13" r="4" />
            </svg>
          </div>
        </div>
        <input
          type="file"
          id="profileInputReports"
          style="display: none"
          (change)="onProfileFileSelected($event)"
          accept="image/*"
        />
      </div>
      <span class="user-name">{{ userName }}</span>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filters-grid">
    <div class="filter-item">
      <select
        [(ngModel)]="selectedSubject"
        (change)="onSubjectChange()"
        class="report-select"
      >
        <option value="">Asignatura y curso</option>
        <option *ngFor="let s of subjects" [value]="s">{{ s }}</option>
      </select>
    </div>
    <div class="filter-item">
      <select
        [(ngModel)]="selectedGameId"
        (change)="onGameChange()"
        class="report-select"
        [disabled]="!selectedSubject"
      >
        <option value="">Nombre de la partida</option>
        <option *ngFor="let g of filteredGames" [value]="g.idPartida._id">
          {{ g.idPartida.nombrePartida || g.idPartida.idCuestionario.titulo }}
        </option>
      </select>
    </div>
  </div>

  <!-- Contenido de Reportes -->
  <div class="reports-content" *ngIf="selectedGameId; else emptyState">
    <!-- Rendimiento Alumno -->
    <section class="report-section">
      <h3 class="section-label">Rendimiento {{ userName }}</h3>
      <div class="report-card green">
        <div class="card-main">
          <strong
            >{{ selectedSubject.split("/")[0] }}: {{ performance.accuracy }}%
            aciertos ({{ performance.status }})</strong
          >
        </div>
      </div>
    </section>

    <!-- Preguntas Incorrectas -->
    <section class="report-section" *ngIf="failedQuestions.length > 0">
      <h3 class="section-label">Preguntas incorrectas</h3>
      <div class="report-card red">
        <div class="failed-questions-list">
          <div *ngFor="let q of failedQuestions" class="failed-item">
            <strong>P{{ q.questionIndex }}:</strong> {{ q.textoPregunta }}
          </div>
        </div>
      </div>
    </section>

    <!-- Preguntas Sin Responder -->
    <section class="report-section" *ngIf="unansweredQuestions.length > 0">
      <h3 class="section-label">Preguntas sin responder</h3>
      <div class="report-card gray">
        <div class="failed-questions-list">
          <div *ngFor="let q of unansweredQuestions" class="unanswered-item">
            <strong>P{{ q.questionIndex }}:</strong> {{ q.textoPregunta }}
          </div>
        </div>
      </div>
    </section>

    <!-- Mensaje si no hubo errores -->
    <section
      class="report-section"
      *ngIf="
        failedQuestions.length === 0 &&
        unansweredQuestions.length === 0 &&
        selectedGameDetails
      "
    >
      <h3 class="section-label">Resultado</h3>
      <div class="report-card green">
        <div class="card-main">
          <strong
            >¡Increíble! Has respondido correctamente todas las
            preguntas.</strong
          >
        </div>
      </div>
    </section>

    <!-- Evolución en la asignatura -->
    <section class="report-section">
      <h3 class="section-label">Evolución en la asignatura</h3>
      <div class="evolution-box">
        <div class="evolution-list">
          <div *ngFor="let ev of subjectEvolution" class="evolution-item">
            {{ ev.subject }}: {{ ev.accuracy }}% aciertos ({{ ev.status }})
          </div>
          <div *ngIf="subjectEvolution.length === 0" class="empty-list">
            No hay datos de evolución disponibles.
          </div>
        </div>
      </div>
    </section>

    <!-- Resumen -->
    <div class="report-summary">
      <p>{{ getSummary() }}</p>
    </div>
  </div>

  <!-- Botones de Acción -->
  <div class="actions-footer">
    <button class="btn-action back" (click)="goBack()">
      Volver a Dashboard
    </button>
    <button
      class="btn-action export"
      (click)="exportPDF()"
      [disabled]="!selectedGameId || isDownloadingPDF"
    >
      {{ isDownloadingPDF ? "Exportando..." : "Exportar PDF" }}
    </button>
  </div>

  <ng-template #emptyState>
    <div class="empty-reports">
      <p *ngIf="!isLoading">
        Selecciona una asignatura y una partida para ver tus resultados
        detallados.
      </p>
      <div class="spinner" *ngIf="isLoading"></div>
    </div>
  </ng-template>
</div>
