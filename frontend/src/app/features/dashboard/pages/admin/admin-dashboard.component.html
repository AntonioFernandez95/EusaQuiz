<div class="admin-container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <img
        [src]="brandingService.appLogo$ | async"
        [alt]="brandingService.appName$ | async"
        class="logo"
      />
      <h2>{{ brandingService.appName$ | async }} Admin</h2>
    </div>
    <nav class="sidebar-nav">
      <button
        [class.active]="activeView === 'overview'"
        (click)="setTab('overview')"
      >
        <i class="fas fa-chart-line"></i> Resumen
      </button>
      <button [class.active]="activeView === 'users'" (click)="setTab('users')">
        <i class="fas fa-users"></i> Usuarios
      </button>
      <button [class.active]="activeView === 'games'" (click)="setTab('games')">
        <i class="fas fa-gamepad"></i> Partidas
      </button>
      <button [class.active]="activeView === 'data'" (click)="setTab('data')">
        <i class="fas fa-database"></i> Datos
      </button>
      <button
        [class.active]="activeView === 'branding'"
        (click)="setTab('branding')"
      >
        <i class="fas fa-palette"></i> Branding
      </button>
    </nav>
  </aside>

  <main class="content">
    <header class="dashboard-header top-bar animate-fade-in">
      <div class="page-title-center">Panel de Control</div>

      <div class="user-profile">
        <div class="user-avatar-wrapper">
          <div class="user-avatar">
            <img
              *ngIf="userProfileImg"
              [src]="userProfileImg"
              alt="Perfil"
              class="profile-img-avatar"
            />
            <span *ngIf="!userProfileImg">{{ userInitials }}</span>
          </div>
        </div>
        <span class="user-name">{{ userName }}</span>
        <div class="badge ml-2">ADMIN</div>
        <button class="btn-logout" (click)="logout()" title="Cerrar sesión">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
    </header>

    <div *ngIf="loading" class="loader-container">
      <div class="spinner"></div>
    </div>

    <div
      *ngIf="!loading && activeView === 'overview'"
      class="overview-grid animate__animated animate__fadeIn"
    >
      <!-- Stats Cards -->
      <div class="stat-card blue">
        <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
        <div class="stat-info">
          <h3>Total Usuarios</h3>
          <p class="value">{{ stats.totalUsuarios }}</p>
        </div>
      </div>
      <div class="stat-card purple">
        <div class="stat-icon"><i class="fas fa-trophy"></i></div>
        <div class="stat-info">
          <h3>Partidas Totales</h3>
          <p class="value">{{ stats.totalPartidas }}</p>
        </div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon"><i class="fas fa-signal"></i></div>
        <div class="stat-info">
          <h3>En Vivo</h3>
          <p class="value">{{ stats.partidasActivas }}</p>
        </div>
      </div>

      <!-- Recent Users Table -->
      <div class="data-section full-width">
        <div class="section-header">
          <h2>Usuarios Recientes</h2>
          <button class="btn-link" (click)="setTab('users')">Ver todos</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Centro</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let u of usuariosRecientes">
                <td>
                  <div class="user-cell">
                    <img
                      [src]="
                        u.fotoPerfil
                          ? serverUrl + '/' + u.fotoPerfil
                          : 'assets/img/default-avatar.png'
                      "
                      class="avatar-small"
                    />
                    {{ u.nombre }}
                  </div>
                </td>
                <td>{{ u.email }}</td>
                <td>
                  <span class="role-badge" [ngClass]="u.rol">{{ u.rol }}</span>
                </td>
                <td>{{ u.centro?.nombre || u.centro || "N/A" }}</td>
                <td>{{ u.creadoEn | date: "short" }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Placeholder for other views -->
    <div
      *ngIf="activeView === 'users'"
      class="users-view animate__animated animate__fadeIn"
    >
      <app-admin-users></app-admin-users>
    </div>

    <div
      *ngIf="activeView === 'games'"
      class="games-view animate__animated animate__fadeIn"
    >
      <app-admin-games></app-admin-games>
    </div>

    <div
      *ngIf="activeView === 'data'"
      class="data-view animate__animated animate__fadeIn"
    >
      <app-admin-data></app-admin-data>
    </div>
    <div
      *ngIf="activeView === 'branding'"
      class="branding-view animate__animated animate__fadeIn"
    >
      <div class="branding-glass-card shadow-lg">
        <header class="branding-header">
          <div class="header-icon-box">
            <i class="fas fa-magic"></i>
          </div>
          <div class="header-text">
            <h2>Personalización de Identidad</h2>
            <p>
              Configura la presencia visual de tu plataforma educativa en todo
              el sistema.
            </p>
          </div>
        </header>

        <form (ngSubmit)="saveBranding()" class="premium-branding-form">
          <div class="form-grid">
            <!-- App Name Section -->
            <div class="form-section name-section">
              <div class="input-premium-group">
                <label for="appName">
                  <i class="fas fa-signature"></i> Nombre de la Aplicación
                </label>
                <div class="input-wrapper">
                  <input
                    type="text"
                    id="appName"
                    [(ngModel)]="brandingForm.nombreApp"
                    name="nombreApp"
                    class="premium-input"
                    placeholder="Ej: CampusQuiz"
                  />
                  <span class="input-focus-line"></span>
                </div>
                <small class="helper-text"
                  >Este nombre aparecerá en los títulos, correos y
                  reportes.</small
                >
              </div>
            </div>

            <!-- Logo Section -->
            <div class="form-section logo-section">
              <label class="section-label">
                <i class="fas fa-image"></i> Logotipo Institucional
              </label>

              <div class="logo-interaction-area">
                <div class="logo-preview-box">
                  <div class="preview-overlay">
                    <span>Vista Previa</span>
                  </div>
                  <img
                    [src]="brandingService.appLogo$ | async"
                    alt="Logo actual"
                    class="brand-logo-main"
                  />
                </div>

                <div class="logo-upload-zone">
                  <input
                    type="file"
                    (change)="onLogoSelected($event)"
                    accept="image/*"
                    id="logoUpload"
                    class="hidden-input"
                  />
                  <label for="logoUpload" class="upload-trigger">
                    <div class="upload-icon">
                      <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                      <span class="primary-text">Cambiar Logotipo</span>
                      <span class="secondary-text"
                        >Formatos sugeridos: PNG, SVG o JPG</span
                      >
                    </div>
                  </label>

                  <div
                    *ngIf="brandingForm.logoFile"
                    class="file-selected-badge animate__animated animate__bounceIn"
                  >
                    <i class="fas fa-check-circle"></i>
                    <span>{{ brandingForm.logoFile.name }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions-premium">
            <button
              type="submit"
              class="btn-save-premium"
              [disabled]="savingBranding"
            >
              <span class="btn-content" *ngIf="!savingBranding">
                <i class="fas fa-check"></i> Aplicar Cambios
              </span>
              <span class="btn-loader" *ngIf="savingBranding">
                <div class="dot-flashing"></div>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>
