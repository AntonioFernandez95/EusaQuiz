<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel Profesor - EusaQuiz</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            background: #f4f4f4;
            text-align: center;
        }

        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }

        input,
        button {
            padding: 10px;
            margin: 5px;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        /* TIMER Y GR√ÅFICA EN VIVO */
        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: purple;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
            margin: 0 auto 20px auto;
            border: 5px solid #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .grafica-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 350px;
            margin-top: 50px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }

        .barra-columna {
            width: 20%;
            max-width: 100px;
            transition: height 1s ease-out;
            position: relative;
            border-radius: 5px 5px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .barra-label {
            position: absolute;
            bottom: -60px;
            color: #333;
            font-size: 0.8em;
            width: 120%;
            line-height: 1.2;
            word-wrap: break-word;
        }

        .count-badge {
            position: absolute;
            top: -35px;
            width: 100%;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 2px 0;
        }

        /* PODIO ESTILOS */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 250px;
            margin: 30px auto;
            max-width: 600px;
            gap: 15px;
        }
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }
        .podium-bar {
            width: 100%;
            border-radius: 5px 5px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            padding-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .podium-1 { order: 2; }
        .podium-2 { order: 1; }
        .podium-3 { order: 3; }

        .podium-1 .podium-bar { height: 180px; background: linear-gradient(to top, #FFD700, #FDB931); z-index: 2; }
        .podium-2 .podium-bar { height: 140px; background: linear-gradient(to top, #C0C0C0, #E0E0E0); z-index: 1; }
        .podium-3 .podium-bar { height: 100px; background: linear-gradient(to top, #CD7F32, #D2691E); z-index: 1; }

        .podium-name { margin-bottom: 5px; font-weight: bold; color: #333; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;}
        .podium-avatar { 
            font-size: 2rem; margin-bottom: 5px;
        }

        .opciones-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .b-0 {
            background: #e21b3c;
        }

        .b-1 {
            background: #1368ce;
        }

        .b-2 {
            background: #d89e00;
        }

        .b-3 {
            background: #26890c;
        }

        /* PODIO */
        .podio-box {
            background: gold;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            color: #5e4802;
        }

        /* ESTILOS REPORTE DETALLADO (NUEVO) */
        .detalle-pregunta {
            text-align: left;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfdfd;
        }

        .detalle-titulo {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }

        .opcion-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }

        .barra-mini {
            height: 10px;
            border-radius: 5px;
            margin-right: 10px;
            min-width: 5px;
        }

        .votos-badge {
            font-weight: bold;
            margin-left: auto;
            background: #eee;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .es-correcta {
            border: 2px solid green;
            background: #eaffea;
        }
    </style>
</head>

<body>
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="img/logo_eusa.png" alt="EusaQuiz Logo" style="height: 60px;">
        <h1>üë®‚Äçüè´ Panel del Profesor</h1>
    </div>

    <div id="setupPartida" class="card">
        <h2>1. Configurar Partida</h2>
        <a href="index.html"><button id="profesor-btn">Volver</button></a>
        
        <label>Elige Cuestionario:</label>
        <select id="selectCuestionario" style="width: 300px; padding: 10px;">
            <option value="">Cargando cuestionarios...</option>
        </select>
        <br><br>

        <div style="margin: 20px auto; border: 1px solid #ccc; padding: 15px; border-radius: 8px; text-align: left; max-width: 500px;">
            <h3>Tipo de Partida</h3>
            <div style="margin-bottom: 15px;">
                <label style="margin-right: 20px; font-size: 1.1em; cursor: pointer;">
                    <input type="radio" name="tipoPartida" value="en_vivo" checked onclick="toggleConfig()"> 
                    üî• En Vivo (Kahoot)
                </label>
                <label style="font-size: 1.1em; cursor: pointer;">
                    <input type="radio" name="tipoPartida" value="examen" onclick="toggleConfig()"> 
                    üìù Examen / Tarea
                </label>
            </div>
            
            <hr style="margin-bottom: 15px;">

            <!-- Config En Vivo -->
            <div id="configEnVivo">
               <label>‚è± Tiempo por pregunta (seg): <input type="number" id="evTiempo" value="20" style="width: 60px;"></label><br>
               <label><input type="checkbox" id="evMezclarP" checked> üîÄ Mezclar preguntas</label><br>
               <label><input type="checkbox" id="evMezclarR" checked> üîÄ Mezclar respuestas</label><br>
               <br>
               <label>üèÜ Modo Puntos: 
                  <select id="evModoCalif">
                     <option value="velocidad_precision">Velocidad + Precisi√≥n</option>
                     <option value="solo_acierto">Solo Acierto (Puntos fijos)</option>
                  </select>
               </label>
            </div>

            <!-- Config Examen -->
            <div id="configExamen" class="hidden">
               <label>üìÖ Fecha de Inicio: <input type="datetime-local" id="exFecha"></label> 
               <br><small style="color: grey;">(Dejar vac√≠o para iniciar inmediatamente)</small><br><br>
               <label>‚è± Tiempo Total (min): <input type="number" id="exTiempo" value="60" style="width: 60px;"></label>
            </div>
        </div>
        
        <input type="text" id="idProfesor" value="PROF_001" style="display:none;"> <!-- Hidden default -->
        <button onclick="crearPartida()" style="background: #007bff; color: white; padding: 15px 30px; font-size: 1.1em;">Crear Sala</button>

        <hr style="margin: 20px 0;">
        
        <h3>üìÖ Ex√°menes Programados (Futuros)</h3>
        <div id="listaProgramadas" style="text-align: left; max-height: 200px; overflow-y: auto; background: #e3f2fd; padding: 10px; margin-top: 10px; border-radius: 5px; border: 1px solid #90caf9;">
            <p>Cargando...</p>
        </div>

        <h3>üóÇ Historial / Activas</h3>
        <button onclick="cargarMisPartidas()">üîÑ Actualizar Listas</button>
        <div id="listaMisPartidas" style="text-align: left; max-height: 300px; overflow-y: auto; background: #eee; padding: 10px; margin-top: 10px; border-radius: 5px;">
            <p>Cargando...</p>
        </div>
    </div>

    <div id="lobbyPartida" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Sala de Espera</h2>
            <button onclick="salirDelLobby()" style="background:#6c757d; font-size:0.9em; padding: 5px 10px; border-radius: 4px;">‚¨Ö Volver</button>
        </div>
        <h1 style="font-size: 4em; margin: 10px;">PIN: <span id="pinDisplay">---</span></h1>
        <p>Jugadores: <span id="contadorJugadores">0</span></p>
        <div id="listaJugadores"></div>
        <br>
        <button onclick="iniciarPartida()" style="background: green; font-size: 1.2em; padding: 15px 30px; color:white; border:none; border-radius:5px; cursor:pointer;">‚ñ∂ INICIAR JUEGO</button>
    </div>

    <!-- SCREEN: EXAMEN PROGRESS (PROFESOR) -->
    <div id="screenExamenProfesor" class="card hidden" style="text-align: center; padding: 50px;">
        <h1 style="color:#2E7D32;">üìù Examen en Curso</h1>
        <p>Los alumnos est√°n respondiendo. No cierre esta pesta√±a.</p>
        
        <div style="font-size: 3em; margin: 30px; font-weight: bold; color: #d32f2f;" id="timerProfe">00:00</div>
        
        <p>Alumnos conectados: <strong><span id="examActivePlayers">--</span></strong></p>

        <button onclick="finalizarPartida()" style="background: #d32f2f; color: white; padding: 15px 30px; border: none; font-size: 1.2em; border-radius: 5px; cursor: pointer; margin-top: 30px;">
            üèÅ Finalizar Examen
        </button>
    </div>

    <!-- SCREEN: DASHBOARD JUEGO EN VIVO -->
    <div id="dashboardJuego" class="card hidden">
        <h2>Pregunta <span id="numPreguntaDisplay">1/10</span></h2>
        <div class="timer-circle" id="timerVisual">20</div>
        <p id="textoPreguntaProfe" style="font-size: 1.5em; font-weight: bold;">¬øPregunta...?</p>
        
        <div id="contenedorGrafica" class="grafica-container hidden">
            <div class="barra-columna b-0" id="bar-0" style="height: 0%;">
                <span class="count-badge">0</span>
                <span class="barra-label" id="label-0"></span>
            </div>
            <div class="barra-columna b-1" id="bar-1" style="height: 0%;">
                <span class="count-badge">0</span>
                <span class="barra-label" id="label-1"></span>
            </div>
            <div class="barra-columna b-2" id="bar-2" style="height: 0%;">
                <span class="count-badge">0</span>
                <span class="barra-label" id="label-2"></span>
            </div>
            <div class="barra-columna b-3" id="bar-3" style="height: 0%;">
                <span class="count-badge">0</span>
                <span class="barra-label" id="label-3"></span>
            </div>
        </div>
    </div>

    <!-- SCREEN: PANTALLA FINAL (RANKING) -->
    <div id="pantallaFinal" class="card hidden" style="text-align: center;">
        <h1>üèÜ Partida Finalizada</h1>
        <div id="rankingFinal"></div>
        <br>
        <button onclick="verDetalles()" style="background: #333;">üìä Ver Detalles</button>
        <button onclick="descargarReporte()" style="background: #28a745;">üìÑ Descargar PDF</button>
        <button onclick="volverAlInicio()" style="background: #6c757d;">üè† Volver al Inicio</button>
    </div>

    <!-- SCREEN: DETALLES POR PREGUNTA -->
    <div id="pantallaDetalles" class="card hidden">
        <h2>üìä Detalle por Pregunta</h2>
        <div id="contenedorDetalles"></div>
        <br>
        <button onclick="volverAlPodio()">‚¨Ö Volver al Podio</button>
    </div>

    <!-- SCREEN: REPORTE EXAMEN FINALIZADO -->
    <div id="screenReporteExamen" class="card hidden" style="text-align: center;">
        <h1>üìù Examen Finalizado</h1>
        <p>El examen ha terminado. Aqu√≠ est√°n los resultados:</p>
        
        <div id="rankingExamen" style="text-align: left; max-width: 600px; margin: 20px auto;"></div>
        
        <br>
        <button onclick="verDetalles()" style="background: #333;">üìä Ver Detalles</button>
        <button onclick="descargarReporte()" style="background: #28a745;">üìÑ Descargar Reporte PDF</button>
        <button onclick="volverAlInicio()" style="background: #6c757d;">üè† Volver al Inicio</button>
    </div>

    <script>
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:') 
            ? 'http://localhost:3000/api' 
            : `${window.location.origin}/api`;

        let socket = null;
        let idPartidaActual = null;
        let timerInterval = null;
        let opcionesActuales = [];
        let reporteGlobal = [];

        window.addEventListener('load', () => {
             cargarCuestionarios();
             cargarMisPartidas();
        });

        async function cargarCuestionarios() {
            const sel = document.getElementById('selectCuestionario');
            try {
                const res = await fetch(`${API_URL}/cuestionarios`);
                const data = await res.json();
                if(data.ok && data.data) {
                    sel.innerHTML = '<option value="">-- Selecciona un Cuestionario --</option>';
                    data.data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c._id;
                        opt.text = `${c.titulo} (${c.asignatura || 'General'})`;
                        sel.appendChild(opt);
                    });
                }
            } catch(e) {
                console.error(e);
                sel.innerHTML = '<option>Error cargando</option>';
            }
        }
        
        async function cargarMisPartidas() {
             const divOtras = document.getElementById('listaMisPartidas');
             const divProgramadas = document.getElementById('listaProgramadas');
             const idProfe = document.getElementById('idProfesor').value; // PROFE_01
             
             divOtras.innerHTML = 'Cargando...';
             divProgramadas.innerHTML = 'Cargando...';
             
             try {
                const res = await fetch(`${API_URL}/partidas?idProfesor=${idProfe}&t=${Date.now()}`);
                const data = await res.json();
                
                if(data.ok && data.data) {
                    divOtras.innerHTML = '';
                    divProgramadas.innerHTML = '';
                    
                    const ahora = new Date();
                    let hayProgramadas = false;
                    let hayOtras = false;

                    if(data.data.length === 0) {
                        divOtras.innerHTML = '<p>No hay partidas creadas.</p>';
                        divProgramadas.innerHTML = '<p>No hay ex√°menes programados.</p>';
                        return;
                    }
                    
                    data.data.forEach(p => {
                        let esProgramada = false;
                        let fechaProg = null;
                        
                        if(p.tipoPartida === 'examen' && p.estadoPartida === 'espera' && p.configuracionExamen?.programadaPara) {
                            fechaProg = new Date(p.configuracionExamen.programadaPara);
                            if(fechaProg > ahora) esProgramada = true;
                        }

                        const targetDiv = esProgramada ? divProgramadas : divOtras;
                        if(esProgramada) hayProgramadas = true; else hayOtras = true;

                        const row = document.createElement('div');
                        row.style.borderBottom = "1px solid #ccc";
                        row.style.padding = "10px";
                        row.style.display = "flex";
                        row.style.justifyContent = "space-between";
                        row.style.alignItems = "center";
                        row.style.background = "white";
                        row.style.marginBottom = "5px";

                        let titulo = "Sin T√≠tulo";
                        if(p.idCuestionario && p.idCuestionario.titulo) titulo = p.idCuestionario.titulo;
                        
                        let estadoColor = "black";
                        if(p.estadoPartida === 'activa') estadoColor = "green";
                        if(p.estadoPartida === 'finalizada') estadoColor = "red";
                        if(p.estadoPartida === 'espera') estadoColor = "orange";

                        let infoExtra = '';
                        if(esProgramada && fechaProg) {
                            infoExtra = `<br><strong style="color:#0277BD">üìÖ Programado para: ${fechaProg.toLocaleString()}</strong>`;
                        }

                        // Bot√≥n de acci√≥n principal
                        // Si es programada, bot√≥n para "Administrar" o "Entrar" (para iniciarla cuando quiera)
                        // Si es activa, "Entrar al Lobby"
                        // Si es finalizada, "Ver Reporte" (ya lo tiene abajo, pero bueno para borrar)
                        
                        // Action buttons logic
                        let botones = `
                            <button onclick="borrarPartida('${p._id}')" style="background: #dc3545; padding: 5px 10px; font-size: 0.8em; margin-left:5px;">üóë</button>
                        `;
                        
                        // Si est√° en espera, permitir Gestionar (ir al lobby) siempre
                        if(p.estadoPartida === 'espera') {
                             botones = `<button onclick="retomarPartida('${p._id}', '${p.pin}')" style="background: #0277BD; padding: 5px 10px; font-size: 0.8em;">‚öôÔ∏è Gestionar</button>` + botones;
                        } else if(p.estadoPartida === 'activa') {
                             botones = `<button onclick="retomarPartida('${p._id}', '${p.pin}')" style="background: #2E7D32; padding: 5px 10px; font-size: 0.8em;">‚ñ∂ En Curso</button>` + botones;
                        } else if(p.estadoPartida === 'finalizada') {
                             botones = `<button onclick="verReportePartida('${p._id}')" style="background: #28a745; padding: 5px 10px; font-size: 0.8em;">üìä Ver Reporte</button>` + botones;
                        }

                        row.innerHTML = `
                            <div>
                                <strong>${titulo}</strong> <small>(${p.tipoPartida})</small>
                                ${infoExtra} <br>
                                <small>PIN: ${p.pin} | <span style="color:${estadoColor}">${p.estadoPartida.toUpperCase()}</span> | Created: ${new Date(p.createdAt || p.inicioEn || Date.now()).toLocaleDateString()}</small>
                            </div>
                            <div>${botones}</div>
                        `;
                        targetDiv.appendChild(row);
                    });

                    if(!hayProgramadas) divProgramadas.innerHTML = '<p style="color:#666; padding:10px;">No hay ex√°menes futuros.</p>';
                    if(!hayOtras) divOtras.innerHTML = '<p style="color:#666; padding:10px;">No hay historial.</p>';

                } else {
                     divOtras.innerHTML = 'Error cargando datos.';
                     divProgramadas.innerHTML = 'Error cargando datos.';
                }
             } catch(e) {
                 divOtras.innerHTML = '<p>Error al cargar partidas.</p>';
                 divProgramadas.innerHTML = 'Error de conexi√≥n.';
                 console.error(e);
             }
        }
        
        function retomarPartida(id, pin) {
            idPartidaActual = id;
            document.getElementById('setupPartida').classList.add('hidden');
            document.getElementById('lobbyPartida').classList.remove('hidden');
            document.getElementById('pinDisplay').innerText = pin;
            conectarSocket(pin);
        }

        async function borrarPartida(id) {
            if(!confirm("¬øEst√°s seguro de borrar esta partida y todos sus datos de alumnos?")) return;
            try {
                const res = await fetch(`${API_URL}/partidas/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if(data.ok) {
                    alert("Partida eliminada");
                    cargarMisPartidas();
                } else {
                    alert("Error eliminando: " + data.error);
                }
            } catch(e) {
                alert("Error de conexi√≥n");
            }
        }

        function salirDelLobby() {
            if(socket) {
                socket.disconnect();
                socket = null;
            }
            idPartidaActual = null;
            document.getElementById('lobbyPartida').classList.add('hidden');
            document.getElementById('setupPartida').classList.remove('hidden');
            cargarMisPartidas();
        }

        async function crearPartida() {
            const idCuestionario = document.getElementById('selectCuestionario').value;
            const idProfesor = document.getElementById('idProfesor').value;

            if(!idCuestionario) { alert("Selecciona un cuestionario"); return; }
            
            const tipo = document.querySelector('input[name="tipoPartida"]:checked').value;

            const bodyData = {
                idCuestionario,
                idProfesor,
                tipoPartida: tipo,
                modoAcceso: 'publica'
            };
            
            if(tipo === 'en_vivo') {
                bodyData.configuracionEnvivo = {
                    tiempoPorPreguntaSeg: document.getElementById('evTiempo').value,
                    mezclarPreguntas: document.getElementById('evMezclarP').checked,
                    mezclarRespuestas: document.getElementById('evMezclarR').checked,
                    modoCalificacion: document.getElementById('evModoCalif').value,
                    mostrarRanking: true
                };
            } else {
                 const fechaStr = document.getElementById('exFecha').value;
                 const programada = fechaStr ? new Date(fechaStr).toISOString() : new Date().toISOString();
                 
                 bodyData.configuracionExamen = {
                     programadaPara: programada,
                     tiempoTotalMin: document.getElementById('exTiempo').value,
                     permitirNavegacion: true,
                     envioAutomatico: true
                 };
            }

            try {
                const res = await fetch(`${API_URL}/partidas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bodyData)
                });
                const data = await res.json();
                if (data.ok) {
                    
                    let esFuturo = false;
                    if(data.data.tipoPartida === 'examen' && data.data.configuracionExamen?.programadaPara) {
                         const f = new Date(data.data.configuracionExamen.programadaPara);
                         // Margen : si es para >1 min en el futuro (time.now+60000)
                         if(f.getTime() > (Date.now() + 60000)) esFuturo = true;
                    }

                    if(esFuturo) {
                        alert("Examen programado. Aparecer√° en la lista de 'Ex√°menes Programados'.");
                        cargarMisPartidas();
                        // Nos quedamos en setupPartida
                        return;
                    }

                    idPartidaActual = data.data.id;
                    document.getElementById('setupPartida').classList.add('hidden');
                    document.getElementById('lobbyPartida').classList.remove('hidden');
                    document.getElementById('pinDisplay').innerText = data.data.pin || (data.data.tipoPartida === 'examen' ? 'EXAMEN' : '---');
                    
                    if(data.data.pin) conectarSocket(data.data.pin);
                    
                } else { alert(data.mensaje || data.error); }
            } catch (e) { console.error(e); }
        }
        
        function toggleConfig() {
           const tipo = document.querySelector('input[name="tipoPartida"]:checked').value;
           if(tipo === 'en_vivo') {
               document.getElementById('configEnVivo').classList.remove('hidden');
               document.getElementById('configExamen').classList.add('hidden');
           } else {
               document.getElementById('configEnVivo').classList.add('hidden');
               document.getElementById('configExamen').classList.remove('hidden');
           }
        }

        function conectarSocket(pin) {
            console.log("Intentando conectar al socket con PIN:", pin);
            socket = io(window.location.origin);

            socket.emit('join_room', { pin, esProfesor: true });

            socket.on('connect', () => {
                console.log("Socket conectado. Uni√©ndose a sala:", pin);
                socket.emit('join_room', { pin, esProfesor: true });
            });

            // RECUPERAR ESTADO AL RECONECTAR
            socket.on('estado_lobby', (data) => {
                document.getElementById('contadorJugadores').innerText = data.total;
                const divLista = document.getElementById('listaJugadores');
                divLista.innerHTML = ''; 
                
                data.jugadores.forEach(j => {
                    const badgeId = `player-${j.idAlumno}`;
                    const span = document.createElement('span');
                    span.id = badgeId;
                    span.style.padding = "5px 10px";
                    span.style.margin = "5px";
                    span.style.background = "#ddd";
                    span.style.borderRadius = "15px";
                    span.style.display = "inline-block";
                    span.innerText = j.nombre;
                    divLista.appendChild(span);
                });
            });

            // 1. NUEVO JUGADOR (CON ID PARA PODER BORRARLO)
            socket.on('nuevo_jugador', (data) => {
                document.getElementById('contadorJugadores').innerText = data.total;
                document.getElementById('examActivePlayers').innerText = data.total;

                // ID √öNICO PARA EL ELEMENTO HTML
                const badgeId = `player-${data.idAlumno}`;

                if (!document.getElementById(badgeId)) {
                    const span = document.createElement('span');
                    span.id = badgeId;
                    span.style.padding = "5px 10px";
                    span.style.margin = "5px";
                    span.style.background = "#ddd";
                    span.style.borderRadius = "15px";
                    span.style.display = "inline-block";
                    span.innerText = data.nombre;
                    document.getElementById('listaJugadores').appendChild(span);
                }
            });

            // 2. USUARIO DESCONECTADO (BORRAR VISUALMENTE)
            socket.on('usuario_desconectado', (data) => {
                document.getElementById('contadorJugadores').innerText = data.totalParticipantes;
                document.getElementById('examActivePlayers').innerText = data.totalParticipantes;

                if (data.modo === 'lobby') {
                    const badge = document.getElementById(`player-${data.idAlumno}`);
                    if (badge) {
                        badge.remove(); // ¬°Adi√≥s!
                    }
                }
            });

            socket.on('nueva_pregunta', (data) => {
                document.getElementById('lobbyPartida').classList.add('hidden');
                document.getElementById('dashboardJuego').classList.remove('hidden');
                document.getElementById('contenedorGrafica').classList.add('hidden');

                opcionesActuales = data.opciones;

                for (let i = 0; i < 4; i++) {
                    const b = document.getElementById(`bar-${i}`);
                    if (b) {
                        b.style.height = '0%'; b.style.opacity = '1'; b.style.border = "none";
                        const badge = b.querySelector('.count-badge');
                        if (badge) badge.textContent = '0';
                        const label = document.getElementById(`label-${i}`);
                        if (label) label.textContent = "";
                    }
                }

                document.getElementById('numPreguntaDisplay').innerText = data.numeroPregunta + "/" + data.totalPreguntas;
                document.getElementById('textoPreguntaProfe').innerText = data.textoPregunta;
                iniciarTimer(data.tiempoLimite);
            });

            socket.on('tiempo_agotado', (data) => {
                clearInterval(timerInterval);
                document.getElementById('timerVisual').innerText = "0";
                document.getElementById('contenedorGrafica').classList.remove('hidden');

                if (data.stats) {
                    const maxVal = Math.max(...data.stats) || 1;
                    data.stats.forEach((valor, index) => {
                        const barra = document.getElementById(`bar-${index}`);
                        const altura = (valor / maxVal) * 100;
                        barra.style.height = `${altura}%`;
                        barra.querySelector('.count-badge').textContent = valor;
                        const label = document.getElementById(`label-${index}`);
                        if (opcionesActuales[index]) label.innerText = opcionesActuales[index].textoOpcion;

                        if (index === data.correcta) {
                            barra.style.opacity = '1'; barra.style.border = "3px solid black";
                            label.style.color = "green"; label.style.fontWeight = "bold";
                        } else {
                            barra.style.opacity = '0.3'; label.style.color = "#666";
                        }
                    });
                }
            });

            socket.on('fin_partida', async (data) => {
                clearInterval(timerInterval);
                clearInterval(timerExamenProfeInterval);
                
                // Si estamos en modo examen, mostrar pantalla de reporte de examen
                if(tipoPartidaActual === 'examen') {
                    console.log("Examen finalizado. Cargando resultados...");
                    await cargarResultadosExamen();
                    ocultarTodasPantallas();
                    document.getElementById('screenReporteExamen').classList.remove('hidden');
                } else {
                    // Modo en vivo: mostrar pantalla final con ranking
                    ocultarTodasPantallas();
                    document.getElementById('pantallaFinal').classList.remove('hidden');

                    let html = '<div class="podium-container">';
                    
                    // Orden visual: 2 (Plata), 1 (Oro), 3 (Bronce) -> Controlado por CSS 'order'
                    const topRanking = data.ranking.slice(0, 3);
                    const placeholders = [
                        { rank: 2, label: 'ü•à' },
                        { rank: 1, label: 'üëë' },
                        { rank: 3, label: 'ü•â' }
                    ];

                    placeholders.forEach(p => {
                        // El array es 0-indexed, as√≠ que rank 1 es indice 0
                        const idx = p.rank - 1;
                        const jugador = topRanking[idx];
                        
                        // Si hay jugador para esta posici√≥n, lo mostramos
                        // Sino mostramos placeholder vac√≠o o nada si no hay tantos jugadores
                        if(jugador || topRanking.length >= p.rank) {
                            html += `
                            <div class="podium-item podium-${p.rank}">
                                <div class="podium-name">${jugador ? jugador.nombre : '-'}</div>
                                <div class="podium-avatar">${p.label}</div>
                                <div class="podium-bar">
                                    ${jugador ? jugador.puntos : 0}
                                </div>
                            </div>`;
                        }
                    });
                    
                    html += '</div>';

                    // Resto del ranking
                    if(data.ranking.length > 3) {
                         html += '<div style="margin-top:20px; text-align:left; display:inline-block; max-width:500px; width:100%; border-top:1px solid #ddd; padding-top:10px;">';
                         html += '<h3 style="text-align:center; font-size:1rem; margin-bottom:10px;">Resto de participantes</h3>';
                         data.ranking.slice(3).forEach((jugador, i) => {
                             html += `
                             <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; background:${i%2===0 ? '#f9f9f9':'#fff'}">
                                <span>#${i + 4} <b>${jugador.nombre}</b></span>
                                <span>${jugador.puntos} pts</span>
                             </div>`;
                         });
                         html += '</div>';
                    }

                    document.getElementById('rankingFinal').innerHTML = html;
                }
                
                reporteGlobal = data.reporte || [];
            });

            // EVENTO: Inicio de examen
            socket.on('inicio_examen', (data) => {
                console.log("Examen iniciado:", data);
                tipoPartidaActual = 'examen';
                
                // Ocultar lobby, mostrar pantalla examen profesor
                ocultarTodasPantallas();
                document.getElementById('screenExamenProfesor').classList.remove('hidden');
                
                // Actualizar contador de jugadores
                // Usar el valor que viene del servidor, o fallback al del lobby si no viene
                let total = data.totalJugadores;
                if (total === undefined || total === null) {
                    const lobbyCount = document.getElementById('contadorJugadores').innerText;
                    total = lobbyCount || '0';
                }
                document.getElementById('examActivePlayers').textContent = total;
                
                // Iniciar timer del profesor
                iniciarTimerExamenProfesor(data.duracionMin || 60, data.horaInicio || Date.now());
            });
        }

        async function iniciarPartida() {
            if (!idPartidaActual) return;
            await fetch(`${API_URL}/partidas/iniciar/${idPartidaActual}`, { method: 'PUT' });
        }

        function iniciarTimer(segundos) {
            clearInterval(timerInterval);
            let restante = segundos;
            document.getElementById('timerVisual').innerText = restante;
            timerInterval = setInterval(() => {
                restante--;
                document.getElementById('timerVisual').innerText = restante;
                if (restante <= 0) clearInterval(timerInterval);
            }, 1000);
        }

        // --- FUNCIONES PARA VER DETALLES ---
        function verDetalles() {
            document.getElementById('pantallaFinal').classList.add('hidden');
            document.getElementById('pantallaDetalles').classList.remove('hidden');

            const contenedor = document.getElementById('contenedorDetalles');
            contenedor.innerHTML = '';

            reporteGlobal.forEach((pregunta, index) => {
                const totalVotos = pregunta.stats.reduce((a, b) => a + b, 0) || 1;

                let htmlPregunta = `
                    <div class="detalle-pregunta">
                        <div class="detalle-titulo">P${index + 1}: ${pregunta.textoPregunta}</div>
                `;

                pregunta.opciones.forEach((opcion, i) => {
                    const votos = pregunta.stats[i] || 0;
                    const porcentaje = (votos / totalVotos) * 100;
                    const esCorrectaClass = (i === pregunta.correcta) ? 'es-correcta' : '';
                    const colorBarra = ['#e21b3c', '#1368ce', '#d89e00', '#26890c'][i % 4];

                    htmlPregunta += `
                        <div class="opcion-row ${esCorrectaClass}">
                            <div class="barra-mini" style="width: ${porcentaje}%; background: ${colorBarra}; min-width: 5px;"></div>
                            <span>${opcion.textoOpcion}</span>
                            <span class="votos-badge">${votos} votos</span>
                        </div>
                    `;
                });

                htmlPregunta += `</div>`;
                contenedor.innerHTML += htmlPregunta;
            });
        }

        function volverAlPodio() {
            document.getElementById('pantallaDetalles').classList.add('hidden');
            document.getElementById('pantallaFinal').classList.remove('hidden');
        }

        function descargarReporte() {
            if(!idPartidaActual) return alert("Error: ID de partida desconocido");
            const url = `${API_URL}/partidas/${idPartidaActual}/reporte?formato=pdf`;
            window.open(url, '_blank');
        }

        async function verReportePartida(id) {
            idPartidaActual = id;
            await cargarResultadosExamen();
            ocultarTodasPantallas();
            document.getElementById('screenReporteExamen').classList.remove('hidden');
        }

        // --- FUNCIONES PARA MODO EXAMEN ---
        let timerExamenProfeInterval = null;
        let tipoPartidaActual = 'en_vivo'; // Para saber si es examen o en vivo

        async function finalizarPartida() {
            if(!idPartidaActual) return;
            
            if(!confirm("¬øEst√°s seguro de finalizar esta partida? Los alumnos ser√°n desconectados.")) return;
            
            try {
                const res = await fetch(`${API_URL}/partidas/finalizar/${idPartidaActual}`, { method: 'PUT' });
                const data = await res.json();
                
                if(data.ok) {
                    clearInterval(timerExamenProfeInterval);
                    
                    // Cargar resultados del examen
                    await cargarResultadosExamen();
                    
                    // Mostrar pantalla de reporte
                    ocultarTodasPantallas();
                    document.getElementById('screenReporteExamen').classList.remove('hidden');
                } else {
                    alert("Error finalizando: " + (data.error || data.mensaje));
                }
            } catch(e) {
                console.error(e);
                alert("Error de conexi√≥n al finalizar");
            }
        }

        async function cargarResultadosExamen() {
            try {
                const res = await fetch(`${API_URL}/partidas/${idPartidaActual}`);
                const data = await res.json();
                
                if(data.ok && data.data) {
                    const partida = data.data;
                    const rankingDiv = document.getElementById('rankingExamen');
                    rankingDiv.innerHTML = '';
                    
                    if(partida.jugadores && partida.jugadores.length > 0) {
                        // Ordenar por puntuaci√≥n
                        const jugadoresOrdenados = partida.jugadores.sort((a, b) => 
                            (b.puntuacionTotal || 0) - (a.puntuacionTotal || 0)
                        );
                        
                        jugadoresOrdenados.forEach((j, i) => {
                            const nota = j.puntuacionTotal || 0;
                            const colorNota = nota >= 5 ? '#2E7D32' : '#d32f2f';
                            
                            const row = document.createElement('div');
                            row.style.padding = '10px';
                            row.style.marginBottom = '5px';
                            row.style.background = i % 2 === 0 ? '#f5f5f5' : 'white';
                            row.style.borderRadius = '5px';
                            row.style.display = 'flex';
                            row.style.justifyContent = 'space-between';
                            
                            row.innerHTML = `
                                <span><strong>#${i + 1}</strong> ${j.nombreAlumno}</span>
                                <span style="color: ${colorNota}; font-weight: bold;">${nota.toFixed(1)} / 10</span>
                            `;
                            rankingDiv.appendChild(row);
                        });
                    } else {
                        rankingDiv.innerHTML = '<p style="color:#666;">No hay resultados disponibles.</p>';
                    }
                }
            } catch(e) {
                console.error(e);
            }
        }

        function volverAlInicio() {
            ocultarTodasPantallas();
            document.getElementById('setupPartida').classList.remove('hidden');
            idPartidaActual = null;
            if(socket) {
                socket.disconnect();
                socket = null;
            }
            cargarMisPartidas();
        }

        function ocultarTodasPantallas() {
            const pantallas = ['setupPartida', 'lobbyPartida', 'screenExamenProfesor', 'dashboardJuego', 'pantallaFinal', 'pantallaDetalles', 'screenReporteExamen'];
            pantallas.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
        }

        function iniciarTimerExamenProfesor(duracionMin, horaInicio) {
            const finTime = new Date(horaInicio).getTime() + (duracionMin * 60 * 1000);
            
            if(timerExamenProfeInterval) clearInterval(timerExamenProfeInterval);
            
            timerExamenProfeInterval = setInterval(() => {
                const now = Date.now();
                const diff = finTime - now;
                
                if(diff <= 0) {
                    document.getElementById('timerProfe').textContent = "00:00";
                    clearInterval(timerExamenProfeInterval);
                } else {
                    const min = Math.floor(diff / 60000);
                    const sec = Math.floor((diff % 60000) / 1000);
                    document.getElementById('timerProfe').textContent = 
                        `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                }
            }, 1000);
        }
    </script>
</body>

</html>