<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alumno - EusaQuiz</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f0f2f5;
      margin: 0;
    }

    .screen {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .active {
      display: block;
    }

    input {
      width: 80%;
      padding: 15px;
      margin: 10px 0;
      font-size: 1.1em;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    button.btn-primary {
      width: 90%;
      padding: 15px;
      background: #333;
      color: white;
      border: none;
      font-size: 1.2em;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .grid-respuestas {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
      height: 300px;
    }

    .btn-opcion {
      border: none;
      color: white;
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }

    .btn-opcion:active {
      transform: scale(0.96);
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
    }

    .c-0 {
      background-color: #e21b3c;
    }

    .c-1 {
      background-color: #1368ce;
    }

    .c-2 {
      background-color: #d89e00;
    }

    .c-3 {
      background-color: #26890c;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: #555;
      margin-bottom: 20px;
      font-size: 1.2em;
    }

    .timer-badge {
      background: #6f42c1;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
    }

    .podio-item {
      background: #eee;
      margin: 5px;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
  </style>
</head>

<body>
  <div id="screenLogin" class="screen active">
    <a href="profesor.html"><button class="btn-primary">Profesor</button></a>
    <h1>üéì EusaQuiz</h1>
    <input type="text" id="inputPin" placeholder="PIN de juego" />
    <input type="text" id="inputId" placeholder="Tu ID (ej: ASH_K)" />
    <input type="text" id="inputNombre" placeholder="Tu Nombre" />
    <button class="btn-primary" onclick="unirse()">üöÄ Entrar</button>
    
  </div>

  <div id="screenEspera" class="screen">
    <h2>‚úÖ ¬°Est√°s dentro!</h2>
    <h3 id="nombreDisplay">...</h3>
    <p>Mira la pantalla del profesor.</p>
  </div>

  <div id="screenJuego" class="screen">
    <div class="status-bar">
      <span>Pregunta <span id="numPregunta">1</span></span>
      <span class="timer-badge">‚è± <span id="timerAlumno">--</span>s</span>
    </div>
    <h2 id="textoPregunta">...</h2>
    <div id="contenedorOpciones" class="grid-respuestas"></div>
  </div>

  <div id="screenFeedback" class="screen">
    <h1 id="feedbackTitulo" style="font-size: 3em">...</h1>
    <h2 id="feedbackPuntos">...</h2>
  </div>

  <div id="screenPodio" class="screen">
    <h1 style="color: gold">üèÜ RANKING FINAL</h1>
    <div id="listaPodio"></div>
    <br />
    <button class="btn-primary" onclick="location.reload()">Salir</button>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api'
    let socket = null
    let datosJugador = {}
    let idPartidaActual = null
    let idPreguntaActual = null
    let tiempoInicio = 0
    let timerInterval = null

    async function unirse() {
      const pin = document.getElementById('inputPin').value
      const idAlumno = document.getElementById('inputId').value
      const nombreAlumno = document.getElementById('inputNombre').value

      const res = await fetch(`${API_URL}/partidas/unirse/${pin}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idAlumno, nombreAlumno })
      })
      const data = await res.json()
      if (data.ok) {
        datosJugador = { idAlumno, pin }
        idPartidaActual = data.data.idPartida
        document.getElementById('nombreDisplay').innerText = nombreAlumno
        mostrarPantalla('screenEspera')
        conectarSocket(pin)
      } else {
        alert(data.mensaje)
      }
    }

    function conectarSocket(pin) {
      socket = io('http://localhost:3000')

      // --- CAMBIO AQU√ç: Enviamos un OBJETO con m√°s datos, no solo el pin ---
      const payload = {
        pin: pin,
        idPartida: idPartidaActual, // Variable global que ya tienes
        idAlumno: datosJugador.idAlumno // Variable global que ya tienes
      }

      socket.emit('join_room', payload) // Enviamos el objeto completo

      socket.on('connect', () => {
        console.log('Conectado. Uni√©ndose a sala:', pin)
        socket.emit('join_room', payload) // Lo mismo en reconexi√≥n
      })
      // NUEVA PREGUNTA
      socket.on('nueva_pregunta', pregunta => {
        idPreguntaActual = pregunta.idPregunta
        tiempoInicio = Date.now()

        document.getElementById('numPregunta').innerText =
          pregunta.numeroPregunta
        document.getElementById('textoPregunta').innerText =
          pregunta.textoPregunta

        const div = document.getElementById('contenedorOpciones')
        div.innerHTML = ''
        pregunta.opciones.forEach((op, index) => {
          const btn = document.createElement('button')
          btn.className = `btn-opcion c-${index % 4}`
          btn.innerText = op.textoOpcion
          btn.onclick = () => enviarRespuesta(index)
          div.appendChild(btn)
        })

        iniciarTimer(pregunta.tiempoLimite)
        mostrarPantalla('screenJuego')
      })

      // TIEMPO AGOTADO
      socket.on('tiempo_agotado', () => {
        clearInterval(timerInterval)
        if (
          document.getElementById('screenJuego').style.display === 'block'
        ) {
          mostrarPantalla('screenFeedback')
          document.getElementById('feedbackTitulo').innerText = '‚åõ'
          document.getElementById('feedbackPuntos').innerText =
            'Tiempo agotado'
        }
      })

      // FIN PARTIDA (PODIO)
      socket.on('fin_partida', data => {
        clearInterval(timerInterval)
        mostrarPantalla('screenPodio')
        let html = ''
        data.ranking.forEach((j, i) => {
          html += `<div class="podio-item">#${i + 1} ${j.nombre} - <b>${j.puntos
            } pts</b></div>`
        })
        document.getElementById('listaPodio').innerHTML = html
      })
    }

    async function enviarRespuesta(idx) {
      clearInterval(timerInterval)
      mostrarPantalla('screenFeedback')
      document.getElementById('feedbackTitulo').innerText = 'Enviado...'
      document.getElementById('feedbackPuntos').innerText = 'Esperando...'

      await fetch(`${API_URL}/partidas/responder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          idPartida: idPartidaActual,
          idAlumno: datosJugador.idAlumno,
          idPregunta: idPreguntaActual,
          opcionesMarcadas: [idx],
          tiempoEmpleado: (Date.now() - tiempoInicio) / 1000
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            const ok = data.data.esCorrecta
            document.getElementById('feedbackTitulo').innerText = ok
              ? '‚úÖ ¬°BIEN!'
              : '‚ùå MAL'
            document.getElementById('feedbackPuntos').innerText = ok
              ? `+ ${data.data.puntosGanados}`
              : '0 Puntos'
          }
        })
    }

    function iniciarTimer(segundos) {
      clearInterval(timerInterval)
      let rest = segundos
      document.getElementById('timerAlumno').innerText = rest
      timerInterval = setInterval(() => {
        rest--
        document.getElementById('timerAlumno').innerText = rest
        if (rest <= 0) clearInterval(timerInterval)
      }, 1000)
    }

    function mostrarPantalla(id) {
      document
        .querySelectorAll('.screen')
        .forEach(s => s.classList.remove('active'))
      document.getElementById(id).classList.add('active')
    }
  </script>
</body>

</html>