<div class="users-container shadow-sm">
  <div class="search-bar">
    <div class="input-group">
      <i class="fas fa-search"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="filterUsers()"
        placeholder="Buscar por nombre o email..."
      />
    </div>
    <div class="filter-group">
      <select
        [(ngModel)]="courseFilter"
        (change)="filterUsers()"
        class="filter-select"
      >
        <option value="">Todos los cursos</option>
        <option *ngFor="let c of availableCourses" [value]="c">{{ c }}</option>
      </select>
    </div>
    <div class="filter-group">
      <select
        [(ngModel)]="roleFilter"
        (change)="filterUsers()"
        class="filter-select"
      >
        <option value="">Todos los roles</option>
        <option value="profesor">Profesor</option>
        <option value="alumno">Alumno</option>
      </select>
    </div>
    <div class="total-badge">{{ filteredUsers.length }} usuarios</div>
  </div>

  <div class="table-container">
    <table class="styled-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Identificador</th>
          <th>Rol</th>
          <th>Curso / Centro</th>
          <th>Estado</th>
          <th>Fecha de registro</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let u of filteredUsers; trackBy: trackByUserId"
          class="animate__animated animate__fadeIn"
        >
          <td>
            <div class="user-info">
              <img
                [src]="
                  u.fotoPerfil
                    ? serverUrl + '/' + u.fotoPerfil
                    : 'assets/img/default-avatar.png'
                "
                class="avatar"
              />
              <div class="details">
                <span class="name">{{ u.nombre }}</span>
                <span class="email">{{ u.email }}</span>
              </div>
            </div>
          </td>
          <td>
            <code>{{ u.idPortal }}</code>
          </td>
          <td>
            <span class="role-badge" [ngClass]="u.rol">{{ u.rol }}</span>
          </td>
          <td>
            {{ u.curso?.nombre || 'N/A' }} <br /><small>{{
              u.centro?.nombre || u.centro || 'N/A'
            }}</small>
          </td>
          <td>
            <span class="status-dot" [class.active]="u.activo"></span>
            {{ u.activo ? 'Activo' : 'Inactivo' }}
          </td>
          <td>{{ u.creadoEn | date: 'short' }}</td>
          <td>
            <div class="actions">
              <button
                class="btn-icon view"
                (click)="viewDetail(u)"
                title="Ver detalle"
              >
                <i class="fas fa-eye"></i>
              </button>
              <button
                class="btn-icon edit"
                (click)="editUser(u)"
                title="Editar"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-icon delete"
                (click)="deleteUser(u)"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Detail Modal/Overlay -->
  <div *ngIf="selectedUser" class="modal-overlay" (click)="closeDetail()">
    <div class="detail-card" (click)="$event.stopPropagation()">
      <header>
        <h2>Detalle del Usuario</h2>
        <button class="close-btn" (click)="closeDetail()">&times;</button>
      </header>

      <div class="detail-body">
        <div class="profile-header">
          <img
            [src]="
              selectedUser.usuario.fotoPerfil
                ? serverUrl + '/' + selectedUser.usuario.fotoPerfil
                : 'assets/img/default-avatar.png'
            "
            class="large-avatar"
          />
          <div class="main-info">
            <h3>{{ selectedUser.usuario.nombre }}</h3>
            <p>{{ selectedUser.usuario.email }}</p>
            <span class="role-badge" [ngClass]="selectedUser.usuario.rol">{{
              selectedUser.usuario.rol
            }}</span>
          </div>
        </div>

        <div class="tabs-content">
          <div class="tab-section">
            <h4><i class="fas fa-history"></i> Historial de Participaciones</h4>
            <div
              *ngIf="selectedUser.participaciones.length === 0"
              class="empty-msg"
            >
              Sin participaciones registradas.
            </div>
            <ul class="scrollable">
              <li *ngFor="let p of selectedUser.participaciones">
                <strong>{{
                  p.idPartida?.idCuestionario?.titulo || 'Partida eliminada'
                }}</strong>
                <span>Score: {{ p.puntuacionTotal }} pts</span>
                <small>{{ p.fecha | date: 'short' }}</small>
              </li>
            </ul>
          </div>

          <div
            class="tab-section"
            *ngIf="selectedUser.usuario.rol === 'profesor'"
          >
            <h4><i class="fas fa-layer-group"></i> Partidas Creadas</h4>
            <div
              *ngIf="selectedUser.partidasCreadas.length === 0"
              class="empty-msg"
            >
              No ha creado partidas a√∫n.
            </div>
            <ul class="scrollable">
              <li *ngFor="let g of selectedUser.partidasCreadas">
                <strong>PIN: {{ g.pin }}</strong>
                <span>Estado: {{ g.estado }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div *ngIf="editingUser" class="modal-overlay" (click)="cancelEdit()">
    <div class="edit-modal" (click)="$event.stopPropagation()">
      <header>
        <h2>Editar Usuario</h2>
        <button class="close-btn" (click)="cancelEdit()">&times;</button>
      </header>

      <form (ngSubmit)="saveUser()" #editForm="ngForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="editNombre">Nombre completo</label>
            <input
              type="text"
              id="editNombre"
              [(ngModel)]="editFormData.nombre"
              name="nombre"
              required
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="editEmail">Email</label>
            <input
              type="email"
              id="editEmail"
              [(ngModel)]="editFormData.email"
              name="email"
              required
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="editIdPortal">ID Portal</label>
            <input
              type="text"
              id="editIdPortal"
              [(ngModel)]="editFormData.idPortal"
              name="idPortal"
              required
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="editRol">Rol</label>
            <select
              id="editRol"
              [(ngModel)]="editFormData.rol"
              name="rol"
              required
              class="form-control"
            >
              <option value="alumno">Alumno</option>
              <option value="profesor">Profesor</option>
              <option value="admin">Administrador</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editCentro">Centro</label>
            <select
              id="editCentro"
              [(ngModel)]="editFormData.centro"
              name="centro"
              required
              class="form-control form-select"
            >
              <option *ngFor="let c of availableCenters" [value]="c._id">
                {{ c.nombre }}
              </option>
            </select>
            <small>Centros disponibles: {{ availableCenters.length }}</small>
          </div>

          <div class="form-group">
            <label for="editCurso">Curso</label>
            <select
              id="editCurso"
              [(ngModel)]="editFormData.curso"
              name="curso"
              class="form-control"
            >
              <option value="">Sin asignar</option>
              <option *ngFor="let c of availableCoursesObj" [value]="c._id">
                {{ c.nombre }}
              </option>
            </select>
          </div>

          <div
            class="form-group full-width"
            *ngIf="editFormData.rol === 'profesor'"
          >
            <label for="editAsignaturas">Asignaturas asignadas</label>
            <div
              class="subjects-editor"
              *ngIf="availableSubjectGroups.length > 0"
            >
              <div
                *ngFor="let group of availableSubjectGroups"
                class="subject-group"
              >
                <div class="subject-group-title">{{ group.name }}</div>
                <div class="subject-checkboxes">
                  <label
                    *ngFor="let subj of group.subjects"
                    class="subject-checkbox"
                  >
                    <input
                      type="checkbox"
                      [checked]="isSubjectSelected(subj)"
                      (change)="toggleSubject(subj)"
                    />
                    {{ subj }}
                  </label>
                </div>
              </div>
            </div>
            <small
              *ngIf="availableSubjectGroups.length === 0"
              class="text-muted"
            >
              No hay asignaturas disponibles. Asigne primero un curso al
              profesor.
            </small>
            <small *ngIf="selectedSubjects.size > 0" class="selected-count">
              {{ selectedSubjects.size }} asignatura(s) seleccionada(s)
            </small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="editFormData.activo"
                name="activo"
              />
              Usuario activo
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelEdit()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="!editForm.valid || saving"
          >
            {{ saving ? 'Guardando...' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
