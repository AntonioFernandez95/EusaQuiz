<div class="ranking-container">
  <!-- Header -->
  <header class="dashboard-header animate-fade-in">
    <div class="logo" (click)="goBack()">
      <img src="assets/img/logo-camera.png" alt="Eusa Quiz" class="logo-img" />
    </div>

    <div class="page-title-center">
      {{
        tipoPartida === "examen"
          ? partidaActiva
            ? "Seguimiento Examen"
            : "Resultados Examen"
          : "Tabla Posiciones - En Vivo"
      }}
      <span class="status-badge" *ngIf="partidaActiva">En curso</span>
    </div>

    <div class="user-profile">
      <div class="user-avatar-wrapper">
        <div class="user-avatar">
          <img
            *ngIf="userProfileImg"
            [src]="userProfileImg"
            alt="Perfil"
            class="profile-img-avatar"
          />
          <span *ngIf="!userProfileImg">{{ userInitials }}</span>
        </div>
      </div>
      <span class="user-name">{{ userName }}</span>
    </div>
  </header>

  <main class="ranking-content animate-slide-up" *ngIf="ganador">
    <!-- Winner Display -->
    <div class="winner-alert" *ngIf="!partidaActiva">
      <h2 class="winner-label">Ganador Final</h2>
      <p class="winner-name">{{ ganador.nombre }}</p>
    </div>

    <!-- Tracking Info (Examen Activo) -->
    <div class="tracking-summary" *ngIf="partidaActiva">
      <p>
        Los alumnos están realizando el examen. Las notas se actualizarán
        automáticamente a medida que finalicen.
      </p>
    </div>

    <!-- Ranking Table Container -->
    <div class="table-container">
      <table class="ranking-table">
        <thead>
          <tr>
            <th class="col-pos">Posición</th>
            <th class="col-name">Nombre</th>
            <th class="col-points">
              {{ tipoPartida === "examen" ? "Nota" : "Puntos" }}
            </th>
            <th class="col-status" *ngIf="tipoPartida === 'examen'">Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of ranking; let i = index">
            <td class="col-pos">
              <span class="pos-badge" [style.color]="getPosColor(i)">{{
                i + 1
              }}</span>
            </td>
            <td class="col-name">{{ item.nombre }}</td>
            <td class="col-points">
              <span class="points-val">{{ item.puntos }}</span>
            </td>
            <td class="col-status" *ngIf="tipoPartida === 'examen'">
              <span class="state-badge" [class.done]="item.finalizado">
                {{ item.finalizado ? "Terminado" : "Jugando" }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Actions -->
    <div class="action-footer">
      <button
        class="btn-danger"
        *ngIf="
          userRole === 'profesor' && partidaActiva && tipoPartida === 'examen'
        "
        (click)="terminarPartidaManual()"
      >
        Finalizar Examen para todos
      </button>
      <button class="btn-report" *ngIf="!partidaActiva" (click)="showReport()">
        Ver Reporte
      </button>
      <button class="btn-primary" (click)="exit()">Volver al Dashboard</button>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay animate-fade-in" *ngIf="showReportModal">
      <div class="modal-content animate-slide-up">
        <div class="modal-header">
          <h3>Reporte de Partida</h3>
          <button class="close-btn" (click)="closeReport()">&times;</button>
        </div>

        <div class="modal-body">
          <table class="report-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Alumno</th>
                <th>{{ tipoPartida === "examen" ? "Nota" : "Puntos" }}</th>
                <th>Aciertos</th>
                <th>% Acierto</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let row of reportData; let i = index">
                <tr>
                  <td class="col-rank">{{ i + 1 }}</td>
                  <td class="col-name">{{ row.nombre }}</td>
                  <td class="col-score">{{ row.puntos }}</td>
                  <td class="col-hits">{{ row.aciertos }}/{{ row.total }}</td>
                  <td class="col-pct">
                    <span
                      class="pct-badge"
                      [class.high]="row.percentage >= 70"
                      [class.low]="row.percentage < 50"
                    >
                      {{ row.percentage | number : "1.0-1" }}%
                    </span>
                  </td>
                  <td class="col-action">
                    <button class="btn-sm-details" (click)="toggleDetails(i)">
                      {{ expandedIndex === i ? "Ocultar" : "Ver detalles" }}
                    </button>
                  </td>
                </tr>
                <tr *ngIf="expandedIndex === i" class="details-row">
                  <td colspan="6">
                    <div class="inner-details animate-slide-down">
                      <table class="details-table">
                        <thead>
                          <tr>
                            <th>Pregunta</th>
                            <th>Respuesta Alumno</th>
                            <th>Respuesta Correcta</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="let ans of row.detailedAnswers"
                            [class.correct-row]="ans.isCorrect"
                            [class.incorrect-row]="!ans.isCorrect"
                          >
                            <td>{{ ans.questionText }}</td>
                            <td
                              [class.txt-correct]="ans.isCorrect"
                              [class.txt-incorrect]="!ans.isCorrect"
                            >
                              {{ ans.selectedText }}
                              <span *ngIf="ans.isCorrect">✅</span>
                              <span *ngIf="!ans.isCorrect">❌</span>
                            </td>
                            <td class="txt-muted">{{ ans.correctText }}</td>
                          </tr>
                          <tr
                            *ngIf="
                              !row.detailedAnswers ||
                              row.detailedAnswers.length === 0
                            "
                          >
                            <td
                              colspan="3"
                              style="
                                text-align: center;
                                color: #94a3b8;
                                padding: 2rem;
                              "
                            >
                              No hay detalles de respuestas disponibles.
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button
            class="btn-secondary"
            (click)="descargarPDF()"
            [disabled]="isDownloadingPDF"
          >
            {{ isDownloadingPDF ? "Generando..." : "Descargar PDF" }}
          </button>
          <button class="btn-primary" (click)="closeReport()">Cerrar</button>
        </div>
      </div>
    </div>
  </main>
</div>
