<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header animate-fade-in">
    <div class="logo">
      <img
        src="assets/img/logo-camera.png"
        alt="Escuela de Negocios Campus Cámara"
        class="logo-img"
      />
    </div>
    <div class="page-title-center">Dashboard Alumno</div>
    <div class="user-profile">
      <div
        class="user-avatar-wrapper"
        (click)="triggerProfileUpload()"
        title="Cambiar foto de perfil"
      >
        <div class="user-avatar">
          <img
            *ngIf="userProfileImg"
            [src]="userProfileImg"
            alt="Perfil"
            class="profile-img-avatar"
            (error)="onImgError()"
          />
          <!-- Span is now only used if userProfileImg ends up empty even after error, which shouldn't happen with default avatar logic, but kept as severe fallback -->
          <span *ngIf="!userProfileImg">{{ userInitials }}</span>
          <div class="avatar-overlay">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
              />
              <circle cx="12" cy="13" r="4" />
            </svg>
          </div>
        </div>
        <input
          type="file"
          id="profileInput"
          style="display: none"
          (change)="onProfileFileSelected($event)"
          accept="image/*"
        />
      </div>
      <button
        class="btn-change-course"
        (click)="openCourseModal()"
        title="Cambiar mi curso"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-users-group"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
          <path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" />
          <path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
          <path d="M17 10h2a2 2 0 0 1 2 2v1" />
          <path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
          <path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
        </svg>
      </button>
      <span class="user-name">{{ userName }}</span>
      <button class="btn-logout" (click)="logout()" title="Cerrar sesión">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"
          />
        </svg>
      </button>
    </div>
  </header>

  <!-- Botones de Acción Principales -->
  <div class="actions-grid animate-slide-up">
    <button class="action-card btn--join" (click)="joinWithCode()">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"
        />
      </svg>
      Unirse con código
    </button>
    <button class="action-card btn--analysis" (click)="viewReports()">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />
      </svg>
      Análisis y reporte
    </button>
  </div>

  <!-- Partidas Programadas -->
  <section
    class="dashboard-section animate-slide-up"
    style="animation-delay: 0.1s"
  >
    <div class="section-header-row">
      <h2 class="section-title">Partidas programadas</h2>
      <button
        class="btn-icon-refresh"
        (click)="refreshDashboard()"
        title="Actualizar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
          <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
        </svg>
      </button>
    </div>

    <div class="game-list" *ngIf="scheduledGames.length > 0">
      <div *ngFor="let game of scheduledGames" class="card-item scheduled">
        <div class="info">
          <span class="title">
            {{ game.nombrePartida || game.idCuestionario.titulo }}
            <span
              class="meta-tag"
              *ngIf="game.curso || game.idCuestionario?.curso"
              >/ {{ game.curso || game.idCuestionario?.curso }}</span
            >
            <span
              class="meta-tag"
              *ngIf="game.asignatura || game.idCuestionario?.asignatura"
              >/ {{ game.asignatura || game.idCuestionario?.asignatura }}</span
            >
          </span>
        </div>
        <div class="actions">
          <span class="date">{{
            game.fechaProgramada | date : "dd/MM/yyyy HH:mm"
          }}</span>
          <button
            *ngIf="isJoinable(game.fechaProgramada)"
            class="btn-join-small"
            (click)="joinGame(game)"
          >
            Unirse
          </button>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="scheduledGames.length === 0 && !isLoading">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
      <p>No tienes partidas programadas para hoy.</p>
    </div>
  </section>

  <!-- Historial de Resultados -->
  <section
    class="dashboard-section animate-slide-up"
    style="animation-delay: 0.2s"
  >
    <div class="section-header-row">
      <h2 class="section-title">Historial de resultados</h2>
      <button
        class="btn-icon-refresh"
        (click)="refreshDashboard()"
        title="Actualizar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
          <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
        </svg>
      </button>
    </div>

    <div class="history-list" *ngIf="resultsHistory.length > 0">
      <div *ngFor="let result of resultsHistory" class="card-item result">
        <div class="info">
          <span class="title">
            {{
              result.idPartida.nombrePartida ||
                result.idPartida.idCuestionario.titulo
            }}
            <span
              class="meta-tag"
              *ngIf="
                result.idPartida.curso || result.idPartida.idCuestionario?.curso
              "
              >/
              {{
                result.idPartida.curso || result.idPartida.idCuestionario?.curso
              }}</span
            >
            <span
              class="meta-tag"
              *ngIf="
                result.idPartida.asignatura ||
                result.idPartida.idCuestionario?.asignatura
              "
              >/
              {{
                result.idPartida.asignatura ||
                  result.idPartida.idCuestionario?.asignatura
              }}</span
            >
          </span>
          <span class="subtitle"
            >{{ result.respuestasCorrectas }}/{{
              result.totalPreguntas
            }}
            correctas</span
          >
        </div>
        <div class="score-actions">
          <div class="score" [class.low]="result.porcentaje < 50">
            {{ result.porcentaje | number : "1.0-2" }}%
          </div>
          <button
            class="btn-report-small"
            (click)="viewGameReport(result)"
            title="Ver Reporte"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              />
              <polyline points="14 2 14 8 20 8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
              <polyline points="10 9 9 9 8 9" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="resultsHistory.length === 0 && !isLoading">
      <p>Aún no has participado en ningún quiz.</p>
    </div>
  </section>

  <!-- Progreso por Asignatura -->
  <section
    class="dashboard-section animate-slide-up"
    style="animation-delay: 0.3s"
  >
    <h2 class="section-title">Progreso por asignatura</h2>

    <div class="progress-section" *ngIf="subjectProgress.length > 0">
      <div *ngFor="let item of subjectProgress" class="progress-item">
        <div class="progress-info">
          <span class="subject-name">{{ item.subject }}</span>
          <span class="percentage-value" [class.low]="item.percentage < 50"
            >{{ item.percentage }}%</span
          >
        </div>
        <div class="progress-track">
          <div
            class="progress-fill"
            [style.width.%]="item.percentage"
            [class.low]="item.percentage < 50"
          ></div>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="subjectProgress.length === 0 && !isLoading">
      <p>Participa en más quizzes para ver tu progreso.</p>
    </div>
  </section>

  <!-- Modal de Reporte -->
  <div class="modal-overlay animate-fade-in" *ngIf="showReportModal">
    <div class="modal-content animate-slide-up">
      <div class="modal-header">
        <h3>Reporte: {{ selectedGameName }}</h3>
        <button class="close-btn" (click)="closeReport()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="loading-spinner" *ngIf="isLoadingReport">
          <p>Cargando reporte...</p>
        </div>

        <table
          class="report-table"
          *ngIf="!isLoadingReport && reportData.length > 0"
        >
          <thead>
            <tr>
              <th>#</th>
              <th>Alumno</th>
              <th>Puntuación</th>
              <th>Aciertos</th>
              <th>% Acierto</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let row of reportData; let i = index">
              <tr>
                <td class="col-rank">{{ i + 1 }}</td>
                <td class="col-name">{{ row.nombre }}</td>
                <td class="col-score">{{ row.puntos }}</td>
                <td class="col-hits">{{ row.aciertos }}/{{ row.total }}</td>
                <td class="col-pct">
                  <span
                    class="pct-badge"
                    [class.high]="row.percentage >= 70"
                    [class.low]="row.percentage < 50"
                  >
                    {{ row.percentage | number : "1.0-1" }}%
                  </span>
                </td>
                <td class="col-action">
                  <button class="btn-sm-details" (click)="toggleDetails(i)">
                    {{ expandedIndex === i ? "Ocultar" : "Ver detalles" }}
                  </button>
                </td>
              </tr>
              <tr *ngIf="expandedIndex === i" class="details-row">
                <td colspan="6">
                  <div class="inner-details animate-slide-down">
                    <table class="details-table">
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th>Respuesta Alumno</th>
                          <th>Respuesta Correcta</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          *ngFor="let ans of row.detailedAnswers"
                          [class.correct-row]="ans.isCorrect"
                          [class.incorrect-row]="!ans.isCorrect"
                        >
                          <td>{{ ans.questionText }}</td>
                          <td
                            [class.txt-correct]="ans.isCorrect"
                            [class.txt-incorrect]="!ans.isCorrect"
                          >
                            {{ ans.selectedText }}
                            <span *ngIf="ans.isCorrect">✅</span>
                            <span *ngIf="!ans.isCorrect">❌</span>
                          </td>
                          <td class="txt-muted">{{ ans.correctText }}</td>
                        </tr>
                        <tr
                          *ngIf="
                            !row.detailedAnswers ||
                            row.detailedAnswers.length === 0
                          "
                        >
                          <td
                            colspan="3"
                            style="
                              text-align: center;
                              color: #94a3b8;
                              padding: 2rem;
                            "
                          >
                            No hay detalles de respuestas disponibles.
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>

        <div
          class="empty-state"
          *ngIf="!isLoadingReport && reportData.length === 0"
        >
          <p>No hay datos de reporte disponibles.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button
          class="btn-secondary"
          (click)="downloadPDF()"
          [disabled]="
            isDownloadingPDF || isLoadingReport || reportData.length === 0
          "
        >
          <svg
            *ngIf="!isDownloadingPDF"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"
            />
          </svg>
          {{ isDownloadingPDF ? "Generando PDF..." : "Descargar PDF" }}
        </button>
        <button class="btn-primary" (click)="closeReport()">Cerrar</button>
      </div>
    </div>
  </div>
  <!-- Modal Cambio de Curso -->
  <div class="modal-overlay animate-fade-in" *ngIf="showCourseModal">
    <div class="modal-content animate-slide-up small-modal">
      <div class="modal-header">
        <h3>Cambiar de Curso</h3>
        <button
          class="close-btn"
          (click)="closeCourseModal()"
          [disabled]="isUpdatingCourse"
        >
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">Selecciona el curso actual</p>

        <div class="form-group">
          <label>Curso:</label>
          <select [(ngModel)]="selectedCourse" class="form-select">
            <option value="" disabled>Selecciona un curso</option>
            <option *ngFor="let curso of availableCourses" [value]="curso">
              {{ curso }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button
          class="btn-danger-soft"
          (click)="closeCourseModal()"
          [disabled]="isUpdatingCourse"
        >
          Cancelar
        </button>
        <button
          class="btn-primary"
          (click)="saveCourse()"
          [disabled]="isUpdatingCourse || !selectedCourse"
        >
          {{ isUpdatingCourse ? "Guardando..." : "Guardar Cambios" }}
        </button>
      </div>
    </div>
  </div>
</div>
