<div class="reports-container">
  <!-- Header -->
  <header class="reports-header">
    <div class="logo">
      <img src="assets/img/logo-camera.png" alt="Eusa Quiz" class="logo-img" />
    </div>
    <div class="header-center">
      <h2>Análisis y Reportes - PROFESOR</h2>
    </div>
    <div class="user-info">
      <div class="user-avatar">
        <img
          *ngIf="professorProfileImg"
          [src]="professorProfileImg"
          alt="Perfil"
          class="profile-img-avatar"
        />
        <span *ngIf="!professorProfileImg">{{ professorInitials }}</span>
      </div>
      <span class="user-name">{{ professorName }}</span>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filters-grid">
    <div class="filter-item">
      <select
        [(ngModel)]="selectedSubject"
        (change)="onSubjectChange()"
        class="report-select"
      >
        <option value="">Asignatura y curso</option>
        <option *ngFor="let s of subjects" [value]="s">{{ s }}</option>
      </select>
    </div>
    <div class="filter-item">
      <select
        [(ngModel)]="selectedGameId"
        (change)="onGameChange()"
        class="report-select"
        [disabled]="!selectedSubject"
      >
        <option value="">Nombre de la partida</option>
        <option *ngFor="let g of filteredGames" [value]="g._id">
          {{ g.nombrePartida || g.idCuestionario.titulo }}
        </option>
      </select>
    </div>
    <div class="filter-item full-width">
      <select
        [(ngModel)]="selectedStudentId"
        (change)="onStudentChange()"
        class="report-select"
        [disabled]="!selectedGameId"
      >
        <option value="">Seleccionar alumno</option>
        <option *ngFor="let p of players" [value]="p.idAlumno">
          {{ p.nombreAlumno }}
        </option>
      </select>
    </div>
  </div>

  <!-- Contenido de Reportes -->
  <div class="reports-content" *ngIf="selectedGameDetails; else emptyState">
    <!-- Rendimiento Clase -->
    <section class="report-section">
      <h3 class="section-label">Rendimiento clase</h3>
      <div class="report-card orange">
        <div class="card-main">
          <strong>{{ classPerformance.subject }}</strong>
          <span
            >{{ classPerformance.participation }} ·
            {{ classPerformance.accuracy }}% aciertos ({{
              classPerformance.status
            }})</span
          >
        </div>
        <div
          class="card-footer"
          *ngIf="classPerformance.failedQuestionsIndices.length > 0"
        >
          <span
            >Preguntas más falladas:
            {{ classPerformance.failedQuestionsIndices.join(", ") }}</span
          >
        </div>
      </div>
    </section>

    <!-- Rendimiento Alumno (solo si hay alumno seleccionado) -->
    <section class="report-section" *ngIf="selectedStudentId">
      <h3 class="section-label">Rendimiento alumno</h3>
      <div class="report-card green">
        <div class="card-main">
          <strong
            >{{ selectedSubject.split("/")[0] }}:
            {{ studentPerformance.accuracy }}% aciertos ({{
              studentPerformance.status
            }})</strong
          >
        </div>
      </div>
    </section>

    <!-- Preguntas Fallidas (solo si hay alumno seleccionado) -->
    <section
      class="report-section"
      *ngIf="selectedStudentId && failedQuestions.length > 0"
    >
      <h3 class="section-label">Preguntas fallidas</h3>
      <div class="report-card red">
        <div class="failed-questions-list">
          <div
            *ngFor="let q of failedQuestions; let i = index"
            class="failed-item"
          >
            <strong>P{{ i + 1 }}:</strong> {{ q.textoPregunta }}
          </div>
        </div>
      </div>
    </section>

    <!-- Evolución en la asignatura (solo si hay alumno seleccionado) -->
    <section class="report-section" *ngIf="selectedStudentId">
      <h3 class="section-label">Evolución en la asignatura</h3>
      <div class="evolution-box">
        <div class="evolution-list">
          <div *ngFor="let ev of studentEvolution" class="evolution-item">
            {{ ev.subject }}: {{ ev.accuracy }}% aciertos ({{ ev.status }})
          </div>
          <div *ngIf="studentEvolution.length === 0" class="empty-list">
            No hay datos de evolución disponibles.
          </div>
        </div>
      </div>
    </section>

    <!-- Resumen -->
    <div class="report-summary" *ngIf="selectedStudentId">
      <p>{{ getStudentSummary() }}</p>
    </div>
  </div>

  <!-- Botones de Acción -->
  <div class="actions-footer">
    <button class="btn-action logout" (click)="goBack()">
      Volver a Dashboard
    </button>
    <button
      class="btn-action export"
      (click)="exportPDF()"
      [disabled]="!selectedGameId || isDownloadingPDF"
    >
      {{ isDownloadingPDF ? "Exportando..." : "Exportar PDF" }}
    </button>
  </div>

  <ng-template #emptyState>
    <div class="empty-reports">
      <p *ngIf="!isLoading">
        Selecciona una asignatura y una partida para ver los análisis.
      </p>
      <div class="spinner" *ngIf="isLoading"></div>
    </div>
  </ng-template>
</div>
